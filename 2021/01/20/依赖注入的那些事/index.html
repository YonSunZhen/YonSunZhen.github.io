<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="keywords" content="hexo,个人博客,blog" />
  <meta name="description" content="孙永镇个人博客" />
  <meta http-equiv="x-dns-prefetch-control" content="on">
  <link rel="dns-prefetch" href="https://busuanzi.ibruce.info">
  
  <link rel="dns-prefetch" href="https://widget.daovoice.io">
  <link rel="dns-prefetch" href="https://widget-static-cdn.daovoice.io">
  <link rel="dns-prefetch" href="https://im.daovoice.io">
  
  
  <link rel="dns-prefetch" href="https://hm.baidu.com/">
  
  
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
  <link rel="dns-prefetch" href="https://api.github.com">
  <link rel="dns-prefetch" href="https://avatars3.githubusercontent.com">
  
  <link rel="stylesheet" type="text/css" href="/./style/main.4a9772.css">
	<link rel="shortcut icon" href="http://122.51.184.238/storage/api/v1/1_2_博客/2_7_avatar.jpeg" title="Favicon">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
	<title>依赖注入的那些事</title>
  
  <script>var _hmt=_hmt||[];(function(){var hm=document.createElement("script");hm.src="https://hm.baidu.com/hm.js?1b5ca8bbd5cf95a2263942c7c20476d9";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(hm,s);})();
  </script>
  
  
    <script>(function(i,s,o,g,r,a,m){i["DaoVoiceObject"]=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;a.charset="utf-8";m.parentNode.insertBefore(a,m)})(window,document,"script",('https:' == document.location.protocol ? 'https:' : 'http:') + "//widget.daovoice.io/widget/123456.js","daovoice");daovoice('init',{app_id: "123456"});daovoice('update');
  </script>
  
<meta name="generator" content="Hexo 5.4.2"></head>
<body>
<canvas id="pattern-placeholder" height="230"></canvas>
<div class="navbar-header">
  <a class="blog-title" href="/">码上就来</a>
  <a class="face-img" href="/">
    <img src="http://122.51.184.238/storage/api/v1/1_2_博客/2_7_avatar.jpeg">
  </a>
</div>
<main>
  <div class="article-title">
    
  
  <h1 class="title">
    依赖注入的那些事
  </h1>
  


    <ul class="article-info">
      <li>
        发布
        <time datetime="2021-01-20T08:33:48.000Z" itemprop="datePublished">2021-01-20</time>
      </li>
      <li>
        
    更新 <time datetime="2023-05-18T14:27:34.598Z" itemprop="dateUpdated">2023-05-18</time>

      </li>
      <li id="busuanzi_container_page_pv">
        阅读 <span id="busuanzi_value_page_pv"></span>
      </li>
    </ul>
  </div>
  <div class="container">
    <div class="article">
      <div class="content">
        <h2 id="前言">前言</h2>
<p>1、控制反转：Inversion of Control，简称IoC</p>
<p>2、依赖注入：Dependency Injection，简称DI，依赖注入实际上是控制反转概念的一种实现模式。一种消除类之间依赖关系的设计模式。</p>
<p>假设我们有一个类<code>Human</code>，要实例一个<code>Human</code>，我们需要实例一个类<code>Clothes</code>，而实例化衣服<code>Clothes</code>，我们又需要实例化<code>Cloth</code>，实例化纽扣等等。</p>
<p>当需求达到一定复杂的程度时，我们不能为了一个人穿衣服去从布从纽扣开始从头实现，最好能把所有的需求放到一个工厂或者仓库，我们需要什么直接从工厂的仓库里面直接拿（与直接封装成一个<code>Clothes</code>类，我们需要时再去new有什么区别? – 假如去<code>new</code>实例的话，那类与类之间还是存在着依赖关系）。</p>
<p>这个时候就需要依赖注入了，我们实现一个IoC容器（仓库），然后需要衣服就从仓库里面直接拿实例化出来的衣服给人作为属性穿上去就行了。</p>
<p>将所有的类与类之间的依赖关系交给IoC容器去管理，<strong>之后真正使用的是IoC容器中已存在依赖关系的类的实例</strong>（并非再去<code>new</code>新的实例，因此并不会影响类源代码逻辑，个人猜想：若后面需要扩展需求可以根据源类再创建别的容器）</p>
<p>IoC是一种很好的解耦合思想，在开发中，IoC意味着你设计好的对象交给容器控制，而不是使用传统的方式，在对象内部直接控制。在软件开发中有很好的作用。</p>
<h2 id="基于ts中装饰器的使用">基于ts中装饰器的使用</h2>
<h3 id="类装饰器">类装饰器</h3>
<p>类装饰器表达式会在运行时当作函数被调用，<strong>类的构造函数作为其唯一的参数</strong></p>
<p>可以用来监视，修改或替换类定义</p>
<p><strong>修改类的构造器：</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> classDecorator&lt;T <span class="keyword">extends</span> &#123;<span class="title function_">new</span>(...<span class="attr">args</span>:<span class="built_in">any</span>[]):&#123;&#125;&#125;&gt;(<span class="attr">constructor</span>:T) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;装饰器已执行&#x27;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">class</span> <span class="title class_">extends</span> constructor &#123;</span><br><span class="line">    newProperty = <span class="string">&quot;new property&quot;</span>;</span><br><span class="line">    hello = <span class="string">&quot;override&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@classDecorator</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Greeter</span> &#123;</span><br><span class="line">  property = <span class="string">&quot;property&quot;</span>;</span><br><span class="line">  <span class="attr">hello</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">m: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">hello</span> = m;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">hello</span>); </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">new</span> <span class="title class_">Greeter</span>(<span class="string">&quot;world&quot;</span>));</span><br><span class="line"><span class="comment">// 装饰器已执行</span></span><br><span class="line"><span class="comment">// world</span></span><br><span class="line"><span class="comment">// Greeter &#123;</span></span><br><span class="line"><span class="comment">//   property: &#x27;property&#x27;,</span></span><br><span class="line"><span class="comment">//   hello: &#x27;override&#x27;,</span></span><br><span class="line"><span class="comment">//   newProperty: &#x27;new property&#x27;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br></pre></td></tr></table></figure>
<p><strong>程序运行顺序</strong>：<br>
1、为类Greeter添加装饰内容（加在原来类的构造函数后面，因此能起到重写构造函数属性的效果）；<br>
2、实例化类；</p>
<p><strong>修改类的某个方法：</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">cheating</span>(<span class="params">target: <span class="built_in">any</span></span>) &#123;</span><br><span class="line">  target.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">hit</span> = <span class="keyword">function</span>(<span class="params">rival: Somebody</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">hitDamage</span>: <span class="built_in">number</span> = <span class="number">100</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`<span class="subst">$&#123;<span class="variable language_">this</span>.name&#125;</span>对<span class="subst">$&#123;rival.name&#125;</span>造成一次伤害: <span class="subst">$&#123;hitDamage&#125;</span>`</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Somebody</span> &#123;</span><br><span class="line">  <span class="attr">speed</span>: <span class="built_in">number</span> = <span class="number">10</span>;</span><br><span class="line">  <span class="attr">name</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">name: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = name;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">hit</span>(<span class="params">rival: Somebody</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">hitDamage</span>: <span class="built_in">number</span> = <span class="number">10</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`<span class="subst">$&#123;<span class="variable language_">this</span>.name&#125;</span>对<span class="subst">$&#123;rival.name&#125;</span>造成一次伤害：<span class="subst">$&#123;hitDamage&#125;</span>`</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@cheating</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SBody</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Somebody</span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> s0 = <span class="keyword">new</span> <span class="title class_">Somebody</span>(<span class="string">&#x27;小红0&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> s1 = <span class="keyword">new</span> <span class="title class_">SBody</span>(<span class="string">&#x27;小红1&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> rival = <span class="keyword">new</span> <span class="title class_">Somebody</span>(<span class="string">&#x27;小明&#x27;</span>);</span><br><span class="line">s0.<span class="title function_">hit</span>(rival); <span class="comment">// 小红0对小明造成一次伤害：10</span></span><br><span class="line">s1.<span class="title function_">hit</span>(rival); <span class="comment">// 小红1对小明造成一次伤害: 100</span></span><br></pre></td></tr></table></figure>
<h3 id="属性装饰器">属性装饰器</h3>
<p><strong>当要装饰的属性为实例属性时（没有<code>static</code>修饰），装饰的是该类原型上的属性</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">logProperty</span>(<span class="params">params: any</span>) &#123;</span><br><span class="line">  <span class="comment">// target---&gt;类的原型对象；attr---&gt;装饰的属性名</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params">target: any, attr: any</span>) &#123;</span><br><span class="line">    target[attr] = params;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HttpClient1</span> &#123;</span><br><span class="line">  @<span class="title function_">logProperty</span>(<span class="string">&#x27;http://www.baidu1.com&#x27;</span>)</span><br><span class="line">  <span class="attr">url</span>: any | <span class="literal">undefined</span>;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">getUrl</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">url</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HttpClient2</span> &#123;</span><br><span class="line">  @<span class="title function_">logProperty</span>(<span class="string">&#x27;http://www.baidu22.com&#x27;</span>)</span><br><span class="line">  <span class="attr">url</span>: any | <span class="literal">undefined</span> = <span class="string">&#x27;http://www.baidu2.com&#x27;</span>;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">getUrl</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">url</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> http1 = <span class="keyword">new</span> <span class="title class_">HttpClient1</span>();</span><br><span class="line">http1.<span class="title function_">getUrl</span>(); <span class="comment">// http://www.baidu1.com  HttpClient1类中url没有初始化，因此获取的是原型链上的值</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> http2 = <span class="keyword">new</span> <span class="title class_">HttpClient2</span>();</span><br><span class="line">http2.<span class="title function_">getUrl</span>(); <span class="comment">// http://www.baidu2.com 获取的是HttpClient2中url初始化的值（先确定自身对象中是否有这个值，没有的话再去原型链上找，再没有就返回undefined）</span></span><br></pre></td></tr></table></figure>
<p><strong>当要装饰的属性为静态属性时（<code>static</code>修饰），装饰的是该类上的静态属性</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">logProperty</span>(<span class="params">params: any</span>) &#123;</span><br><span class="line">  <span class="comment">// target---&gt;类；attr---&gt;装饰的属性名</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params">target: any, attr: any</span>) &#123;</span><br><span class="line">    target[attr] = params;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HttpClient1</span> &#123;</span><br><span class="line">  @<span class="title function_">logProperty</span>(<span class="string">&#x27;http://www.baidu1.com&#x27;</span>)</span><br><span class="line">  <span class="keyword">static</span> <span class="attr">url</span>: any | <span class="literal">undefined</span>;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">getUrl</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">HttpClient1</span>.<span class="property">url</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HttpClient2</span> &#123;</span><br><span class="line">  @<span class="title function_">logProperty</span>(<span class="string">&#x27;http://www.baidu22.com&#x27;</span>)</span><br><span class="line">  <span class="keyword">static</span> <span class="attr">url</span>: any | <span class="literal">undefined</span> = <span class="string">&#x27;http://www.baidu2.com&#x27;</span>;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">getUrl</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">HttpClient2</span>.<span class="property">url</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">HttpClient1</span>.<span class="property">url</span>); <span class="comment">// http://www.baidu1.com</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">HttpClient2</span>.<span class="property">url</span>); <span class="comment">// http://www.baidu22.com</span></span><br></pre></td></tr></table></figure>
<p><strong>程序运行顺序：</strong><br>
1、为属性执行装饰器函数（给原型上对应属性赋值 || 给类静态属性赋值 || 其他逻辑操作）;<br>
2、实例化类；</p>
<h3 id="参数装饰器">参数装饰器</h3>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 参数装饰器 接受3个参数</span></span><br><span class="line"><span class="comment">// target: Object —— 被装饰的参数所在的方法的类</span></span><br><span class="line"><span class="comment">// methodName: string | symbol —— 方法名</span></span><br><span class="line"><span class="comment">// paramsIndex: number —— 方法中参数的索引值</span></span><br><span class="line"><span class="comment">// 在构造器中的参数使用</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">logParams</span>(<span class="params">params: <span class="built_in">any</span></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params">target: <span class="built_in">any</span>, methodName: <span class="built_in">any</span>, paramsIndex: <span class="built_in">any</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">1</span>, params);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">2</span>, target);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">3</span>, methodName);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">4</span>, paramsIndex);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HttpClient</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="attr">url</span>: <span class="built_in">any</span> | <span class="literal">undefined</span>;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">getData</span>(<span class="params"><span class="meta">@logParams</span>(<span class="string">&#x27;uuid&#x27;</span>) uuid: <span class="built_in">any</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(uuid);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> http = <span class="keyword">new</span> <span class="title class_">HttpClient</span>();</span><br><span class="line">http.<span class="title function_">getData</span>(<span class="number">123456</span>);</span><br><span class="line"><span class="comment">// 1 uuid</span></span><br><span class="line"><span class="comment">// 2 HttpClient &#123;&#125;</span></span><br><span class="line"><span class="comment">// 3 getData</span></span><br><span class="line"><span class="comment">// 4 0</span></span><br><span class="line"><span class="comment">// 123456</span></span><br></pre></td></tr></table></figure>
<h4 id="reflect-metadata">reflect-metadata</h4>
<p>当想要给类中的某个属性或类构造函数中某个参数设置元数据时，一般采用<code>reflect-metadata</code>这种方式（<strong>暂未找到其他方式，原生js如何给一个对象属性设置元数据???，通过反射来获取类属性上面的批注</strong>）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;reflect-metadata&#x27;</span>;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Post</span> &#123;</span><br><span class="line">  @<span class="title class_">Reflect</span>.<span class="title function_">metadata</span>(<span class="string">&#x27;role&#x27;</span>, <span class="string">&#x27;admin&#x27;</span>)</span><br><span class="line">  <span class="attr">haha</span>: &#123;haha?: string; test?: number&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> metadata = <span class="title class_">Reflect</span>.<span class="title function_">getMetadata</span>(<span class="string">&#x27;role&#x27;</span>, <span class="title class_">Post</span>.<span class="property"><span class="keyword">prototype</span></span>, <span class="string">&#x27;haha&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(metadata);  <span class="comment">// admin</span></span><br></pre></td></tr></table></figure>
<p>1、可以用于给类中一些属性设置一些元数据。元数据指的是表述东西时用的数据<br>
2、<code>Reflect.metadata</code>：可以用于给某个类中的某个属性值添加一个元数据（键值对）<br>
3、<code>Reflect.getMetadata</code>：获取某个类中某个属性值的某个元数据（并不会干扰到原来的属性值）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&quot;reflect-metadata&quot;</span>;</span><br><span class="line"><span class="comment">// 用来记录某个属性的元数据</span></span><br><span class="line"><span class="keyword">const</span> formatMetadataKey = <span class="title class_">Symbol</span>(<span class="string">&quot;format&quot;</span>);</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">format</span>(<span class="params">formatString: string</span>) &#123;</span><br><span class="line">  <span class="comment">// Reflect.metadata返回一个函数 (target: Object, propertyKey: string | symbol): void</span></span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">metadata</span>(formatMetadataKey, formatString);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getFormat</span>(<span class="params">target: any, propertyKey: string</span>) &#123;</span><br><span class="line">  <span class="comment">// 获取类中propertyKey的某个元数据(批注)</span></span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">getMetadata</span>(formatMetadataKey, target, propertyKey);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Greeter</span> &#123;</span><br><span class="line">  @<span class="title function_">format</span>(<span class="string">&quot;Hello, %s&quot;</span>)</span><br><span class="line">  <span class="attr">greeting</span>: string;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">message: string</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">greeting</span> = message;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">greet</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> formatString = <span class="title function_">getFormat</span>(<span class="variable language_">this</span>, <span class="string">&quot;greeting&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> formatString.<span class="title function_">replace</span>(<span class="string">&quot;%s&quot;</span>, <span class="variable language_">this</span>.<span class="property">greeting</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> test = <span class="keyword">new</span> <span class="title class_">Greeter</span>(<span class="string">&#x27;syz&#x27;</span>).<span class="title function_">greet</span>();</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(test); <span class="comment">// Hello, syz</span></span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/653bce04db0b">reflect-metadata参考1</a><br>
<a target="_blank" rel="noopener" href="https://ninghao.net/blog/7384">reflect-metadata参考2</a></p>
<h3 id="程序调试技巧">程序调试技巧</h3>
<p>1、使用VS Code配合插件<code>Code Runner</code>（鼠标框选程序右键<code>Run Code</code>即可），因为程序使用的是typescript，使用<code>Code Runner</code>运行需要在全局安装<code>ts-node</code>（<code>npm install ts-node -g</code>）和 <code>typescript</code>（<code>npm install typescript -g</code>）<br>
在文件同级目录下配置一下<code>tsconfig.json</code>文件即可</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;compileOnSave&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="string">&quot;buildOnSave&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="string">&quot;compilerOptions&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;baseUrl&quot;</span>: <span class="string">&quot;./&quot;</span>,</span><br><span class="line">    <span class="string">&quot;module&quot;</span>: <span class="string">&quot;commonjs&quot;</span>,</span><br><span class="line">    <span class="string">&quot;moduleResolution&quot;</span>: <span class="string">&quot;node&quot;</span>,</span><br><span class="line">    <span class="string">&quot;target&quot;</span>: <span class="string">&quot;ES6&quot;</span>,</span><br><span class="line">    <span class="string">&quot;emitDecoratorMetadata&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;experimentalDecorators&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;allowSyntheticDefaultImports&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;noImplicitAny&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;removeComments&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&quot;sourceMap&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&quot;inlineSourceMap&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;noEmitHelpers&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&quot;declaration&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>2、备注</strong>：<code>tsc xxx.js</code>可将ts文件编译为js文件，可以查看编译后的js代码，可能更容易理解！</p>
<h2 id="简易DI实现">简易DI实现</h2>
<p><strong>涉及到类装饰器 &amp; 属性装饰器的使用</strong></p>
<h3 id="思路流程">思路流程</h3>
<p>1、实现一个IoC容器 <code>Injector</code> ，并实例化一个根容器<code>rootInjector</code>（用于存放各个依赖的工厂容器）<br>
2、实现一个依赖注入方法<code>Injectable(...)</code>（用于将各个依赖类注入根容器）<br>
3、实现基于注解的属性注入方法<code>Inject(...)</code>（将类需要用到的依赖从根容器取出来并注入到类中，若根容器不存在则创建此依赖）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;reflect-metadata&#x27;</span>;</span><br><span class="line"><span class="comment">// 工厂里面的各种操作</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">Injector</span> &#123;</span><br><span class="line">  private readonly <span class="attr">providerMap</span>: <span class="title class_">Map</span>&lt;any, any&gt; = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line">  private readonly <span class="attr">instanceMap</span>: <span class="title class_">Map</span>&lt;any, any&gt; = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line">  public <span class="title function_">setProvider</span>(<span class="attr">key</span>: any, <span class="attr">value</span>: any): <span class="keyword">void</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">providerMap</span>.<span class="title function_">has</span>(key)) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">providerMap</span>.<span class="title function_">set</span>(key, value);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  public <span class="title function_">getProvider</span>(<span class="attr">key</span>: any): any &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">providerMap</span>.<span class="title function_">get</span>(key);</span><br><span class="line">  &#125;</span><br><span class="line">  public <span class="title function_">setInstance</span>(<span class="attr">key</span>: any, <span class="attr">value</span>: any): <span class="keyword">void</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">instanceMap</span>.<span class="title function_">has</span>(key)) <span class="variable language_">this</span>.<span class="property">instanceMap</span>.<span class="title function_">set</span>(key, value);</span><br><span class="line">  &#125;</span><br><span class="line">  public <span class="title function_">getInstance</span>(<span class="attr">key</span>: any): any &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">instanceMap</span>.<span class="title function_">has</span>(key)) <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">instanceMap</span>.<span class="title function_">get</span>(key);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  public <span class="title function_">setValue</span>(<span class="attr">key</span>: any, <span class="attr">value</span>: any): <span class="keyword">void</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">instanceMap</span>.<span class="title function_">has</span>(key)) <span class="variable language_">this</span>.<span class="property">instanceMap</span>.<span class="title function_">set</span>(key, value);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 表示根注入器(用于存放各个依赖的根容器)</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> rootInjector = <span class="keyword">new</span> <span class="title class_">Injector</span>();</span><br><span class="line"><span class="comment">// 将类注入到工厂中 类装饰器返回一个值，它会使用提供的构造函数来替换原来类的声明</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">Injectable</span>(<span class="params"></span>): <span class="function">(<span class="params">_constructor: any</span>) =&gt;</span> any &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params">_constructor: any</span>): any &#123;</span><br><span class="line">    rootInjector.<span class="title function_">setProvider</span>(_constructor, _constructor);</span><br><span class="line">    <span class="keyword">return</span> _constructor;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 将依赖注入到生产者</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">Inject</span>(<span class="params"></span>): <span class="function">(<span class="params">_constructor: any, propertyName: string</span>) =&gt;</span> any &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params">_constructor: any, propertyName: string</span>): any &#123;</span><br><span class="line">    <span class="comment">// 获取属性定义时的类型</span></span><br><span class="line">    <span class="keyword">const</span>  <span class="attr">propertyType</span>: any = <span class="title class_">Reflect</span>.<span class="title function_">getMetadata</span>(<span class="string">&#x27;design:type&#x27;</span>, _constructor, propertyName);</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">injector</span>: <span class="title class_">Injector</span> = rootInjector;</span><br><span class="line">    <span class="keyword">let</span> providerInsntance = injector.<span class="title function_">getInstance</span>(propertyType);</span><br><span class="line">    <span class="keyword">if</span> (!providerInsntance) &#123;</span><br><span class="line">      <span class="keyword">const</span> providerClass = injector.<span class="title function_">getProvider</span>(propertyType);</span><br><span class="line">      providerInsntance = <span class="keyword">new</span> <span class="title function_">providerClass</span>();</span><br><span class="line">      injector.<span class="title function_">setInstance</span>(propertyType, providerInsntance);</span><br><span class="line">    &#125;</span><br><span class="line">    _constructor[propertyName] = providerInsntance;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line">@<span class="title class_">Injectable</span>()</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Cloth</span> &#123;</span><br><span class="line">  <span class="attr">name</span>: string = <span class="string">&#x27;麻布&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line">@<span class="title class_">Injectable</span>()</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Clothes</span> &#123;</span><br><span class="line">  <span class="comment">// 为类Clothes注入类Cloth 之后类Clothes就拥有了使用类Cloth的能力</span></span><br><span class="line">  @<span class="title class_">Inject</span>()</span><br><span class="line">  <span class="attr">cloth</span>: <span class="title class_">Cloth</span>;</span><br><span class="line">  <span class="attr">clotheName</span>: string;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">cloth</span> = <span class="variable language_">this</span>.<span class="property">cloth</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">clotheName</span> = <span class="variable language_">this</span>.<span class="property">clotheName</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">updateName</span>(<span class="params">name: string</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">clotheName</span> = name;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Human1</span> &#123;</span><br><span class="line">  @<span class="title class_">Inject</span>() </span><br><span class="line">  <span class="attr">clothes</span>: <span class="title class_">Clothes</span>;</span><br><span class="line">  <span class="attr">name</span>: string;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">name: string</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">clothes</span> = <span class="variable language_">this</span>.<span class="property">clothes</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = name;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">update</span>(<span class="params">name: string</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">clothes</span>.<span class="title function_">updateName</span>(name);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 单例：用于数据状态的维护(一个变 所有变)</span></span><br><span class="line"><span class="keyword">const</span> pepe1 = <span class="keyword">new</span> <span class="title class_">Human1</span>(<span class="string">&#x27;syz&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(pepe1);</span><br><span class="line"><span class="comment">// Human1 &#123;</span></span><br><span class="line"><span class="comment">//   clothes: Clothes &#123; cloth: Cloth &#123; name: &#x27;麻布&#x27; &#125;, clotheName: undefined &#125;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line">pepe1.<span class="title function_">update</span>(<span class="string">&#x27;耐克&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(pepe1);</span><br><span class="line"><span class="comment">// Human1 &#123;</span></span><br><span class="line"><span class="comment">//   clothes: Clothes &#123; cloth: Cloth &#123; name: &#x27;麻布&#x27; &#125;, clotheName: &#x27;耐克&#x27; &#125;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://juejin.im/post/6844903768815828999">简易DI参考</a></p>
<h2 id="仿Angular中的DI">仿Angular中的DI</h2>
<p>service依赖注入，使用单例模式，以后单个或多个组件需要使用这个服务时，都是共享同一个实例（<strong>因此可用于状态共享</strong>），极大的减少了内存资源的损耗。</p>
<blockquote>
<p>在某个注入器的范围内，服务是单例的。也就是说，在指定的注入器中最多只有某个服务的最多一个实例。<br>
应用只有一个根注入器。在root或AppModule级提供UserService意味着它注册到了根注入器上。在整个应用中只有一个UserService实例，每个要求注入UserService的类都会得到这一个服务实例，除非你在子注入器中配置了另一个提供者</p>
</blockquote>
<p>1、如何将依赖从容器中取出来呢 – 调用<code>inject()</code>方法会返回类的实例（<code>Reflect.construct(...)</code>用于实例化，接着调用了类的构造函数，将对应的依赖实例作为构造函数参数传进去）<br>
2、写在类中<code>constructor()</code>中的参数都是要注入依赖的。普通类型，例如<code>string</code>，<code>number</code>不能写进去，否则报错</p>
<p>相关技术：<br>
1、类装饰器，配合<code>reflect-metadata</code><br>
2、参数装饰器，配合<code>reflect-metadata</code></p>
<h3 id="代码实现">代码实现</h3>
<p>1、实现<code>Injectable()</code>类装饰器，用于标记类是否可被注入容器中</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Type</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./type&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;reflect-metadata&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">INJECTABLE_METADATA_KEY</span> = <span class="title class_">Symbol</span>(<span class="string">&#x27;INJECTABLE_KEY&#x27;</span>);</span><br><span class="line"><span class="comment">// 必须被这个装饰器修饰的Class才说明是可以被注入的 (表示Class自己承认是可被注入的)</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">Injectable</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params">target: <span class="built_in">any</span></span>) &#123;</span><br><span class="line">    <span class="title class_">Reflect</span>.<span class="title function_">defineMetadata</span>(<span class="variable constant_">INJECTABLE_METADATA_KEY</span>, <span class="literal">true</span>, target);</span><br><span class="line">    <span class="keyword">return</span> target;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查Class是否可被注入</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> isInjectable&lt;T&gt;(<span class="attr">target</span>: <span class="title class_">Type</span>&lt;T&gt;) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">getMetadata</span>(<span class="variable constant_">INJECTABLE_METADATA_KEY</span>, target) === <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2、实现<code>Inject()</code>参数装饰器，用于将value值注入类中</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Token</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./provider&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;reflect-metadata&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">INJECT_METADATA_KEY</span> = <span class="title class_">Symbol</span>(<span class="string">&#x27;INJECT_KEY&#x27;</span>);</span><br><span class="line"><span class="comment">// 参数装饰器 接受3个参数</span></span><br><span class="line"><span class="comment">// target: Object —— 被装饰的参数所在的方法的类</span></span><br><span class="line"><span class="comment">// methodName: string | symbol —— 方法名</span></span><br><span class="line"><span class="comment">// parameterIndex: number —— 方法中参数的索引值</span></span><br><span class="line"><span class="comment">// 在构造器中的参数使用</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">Inject</span>(<span class="params">token: Token&lt;<span class="built_in">any</span>&gt;</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params">target: <span class="built_in">any</span>, _: <span class="built_in">string</span> | <span class="built_in">symbol</span>, index: <span class="built_in">number</span></span>) &#123;</span><br><span class="line">    <span class="title class_">Reflect</span>.<span class="title function_">defineMetadata</span>(<span class="variable constant_">INJECT_METADATA_KEY</span>, token,target,<span class="string">`index-<span class="subst">$&#123;index&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">return</span> target;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getInjectionToken</span>(<span class="params">target: <span class="built_in">any</span>, index: <span class="built_in">number</span></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">getMetadata</span>(<span class="variable constant_">INJECT_METADATA_KEY</span>, target, <span class="string">`index-<span class="subst">$&#123;index&#125;</span>`</span>) <span class="keyword">as</span> <span class="title class_">Token</span>&lt;<span class="built_in">any</span>&gt; | <span class="literal">undefined</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3、实现<code>addProvider(...)</code>方法，用于将所有需要注入到容器的所有类/值添加到<code> providers</code>变量中，后续<code>inject(...)</code>将从<code>providers</code>取值</p>
<p>4、实现<code>inject(...)</code>方法，将类注入容器并返回实例（使用<code>Reflect.construct</code>方法）</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">Container</span> &#123;</span><br><span class="line"></span><br><span class="line">  providers = <span class="keyword">new</span> <span class="title class_">Map</span>&lt;<span class="title class_">Token</span>&lt;<span class="built_in">any</span>&gt;, <span class="title class_">Provider</span>&lt;<span class="built_in">any</span>&gt;&gt;();</span><br><span class="line">  instances = <span class="keyword">new</span> <span class="title class_">Map</span>&lt;<span class="title class_">Token</span>&lt;<span class="built_in">any</span>&gt;, <span class="built_in">any</span>&gt;();</span><br><span class="line">  </span><br><span class="line">  addProvider&lt;T&gt;(<span class="attr">provider</span>: <span class="title class_">Provider</span>&lt;T&gt;) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">assertInjectableIfClassProvider</span>(provider);</span><br><span class="line">    <span class="comment">// 重复注入同个类的话 貌似是以后面的为准???</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">providers</span>.<span class="title function_">set</span>(provider.<span class="property">provide</span>, provider);</span><br><span class="line">  &#125;</span><br><span class="line">  inject&lt;T&gt;(<span class="attr">type</span>: <span class="title class_">Token</span>&lt;T&gt;): T &#123;    </span><br><span class="line">    <span class="keyword">let</span> provider = <span class="variable language_">this</span>.<span class="property">providers</span>.<span class="title function_">get</span>(<span class="keyword">type</span>);</span><br><span class="line">    <span class="keyword">let</span> instance = <span class="variable language_">this</span>.<span class="property">instances</span>.<span class="title function_">get</span>(<span class="keyword">type</span>);</span><br><span class="line">    <span class="keyword">if</span>(provider === <span class="literal">undefined</span> &amp;&amp; !(<span class="keyword">type</span> <span class="keyword">instanceof</span> <span class="title class_">InjectionToken</span>)) &#123;</span><br><span class="line">      provider = &#123; <span class="attr">provide</span>: <span class="keyword">type</span>, <span class="attr">useClass</span>: <span class="keyword">type</span> &#125;;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">assertInjectableIfClassProvider</span>(provider);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 容器中是否已存在实例 存在的话直接返回原有的实例 共享变量</span></span><br><span class="line">    <span class="keyword">if</span>(instance) &#123;</span><br><span class="line">      <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">injectWithProvider</span>(<span class="keyword">type</span>, provider);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">private</span> assertInjectableIfClassProvider&lt;T&gt;(<span class="attr">provider</span>: <span class="title class_">Provider</span>&lt;T&gt;) &#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_">isClassProvider</span>(provider) &amp;&amp; !<span class="title function_">isInjectable</span>(provider.<span class="property">useClass</span>)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(</span><br><span class="line">        <span class="string">`Cannot provide <span class="subst">$&#123;<span class="variable language_">this</span>.getTokenName(provider.provide)&#125;</span> using class <span class="subst">$&#123;<span class="variable language_">this</span>.getTokenName( provider.useClass )&#125;</span>, </span></span><br><span class="line"><span class="string">        <span class="subst">$&#123;<span class="variable language_">this</span>.getTokenName(provider.useClass)&#125;</span> isn&#x27;t injectable`</span></span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">private</span> getTokenName&lt;T&gt;(<span class="attr">token</span>: <span class="title class_">Token</span>&lt;T&gt;) &#123;</span><br><span class="line">    <span class="keyword">return</span> token <span class="keyword">instanceof</span> <span class="title class_">InjectionToken</span> ? token.<span class="property">injectionIdentifier</span> : token.<span class="property">name</span></span><br><span class="line">  &#125; </span><br><span class="line">  <span class="keyword">private</span> injectWithProvider&lt;T&gt;(<span class="attr">type</span>: <span class="title class_">Token</span>&lt;T&gt;, provider?: <span class="title class_">Provider</span>&lt;T&gt;): T &#123;</span><br><span class="line">    <span class="keyword">let</span> instance;</span><br><span class="line">    <span class="keyword">if</span> (provider === <span class="literal">undefined</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`No provider for type <span class="subst">$&#123;<span class="variable language_">this</span>.getTokenName(<span class="keyword">type</span>)&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isClassProvider</span>(provider)) &#123;</span><br><span class="line">      instance = <span class="variable language_">this</span>.<span class="title function_">injectClass</span>(provider <span class="keyword">as</span> <span class="title class_">ClassProvider</span>&lt;T&gt;);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">isValueProvider</span>(provider)) &#123;</span><br><span class="line">      instance =  <span class="variable language_">this</span>.<span class="title function_">injectValue</span>(provider <span class="keyword">as</span> <span class="title class_">ValueProvider</span>&lt;T&gt;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      instance = <span class="variable language_">this</span>.<span class="title function_">injectFactory</span>(provider <span class="keyword">as</span> <span class="title class_">FactoryProvider</span>&lt;T&gt;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">addInstances</span>(<span class="keyword">type</span>, instance);</span><br><span class="line">    <span class="keyword">return</span> instance;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 关键 在实例化服务类时 需要构造该服务类依赖的独享(即在构造函数中注入的依赖)</span></span><br><span class="line">  <span class="keyword">private</span> injectClass&lt;T&gt;(<span class="attr">classProvider</span>: <span class="title class_">ClassProvider</span>&lt;T&gt;): T &#123;</span><br><span class="line">    <span class="keyword">const</span> target = classProvider.<span class="property">useClass</span>;</span><br><span class="line">    <span class="keyword">const</span> params = <span class="variable language_">this</span>.<span class="title function_">getInjectedParams</span>(target);</span><br><span class="line">    <span class="comment">// 这里的作用 类似于 new target(...params)</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">construct</span>(target, params);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">private</span> injectValue&lt;T&gt;(<span class="attr">valueProvider</span>: <span class="title class_">ValueProvider</span>&lt;T&gt;): T &#123;</span><br><span class="line">    <span class="keyword">return</span> valueProvider.<span class="property">useValue</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">private</span> injectFactory&lt;T&gt;(<span class="attr">factoryProvider</span>: <span class="title class_">FactoryProvider</span>&lt;T&gt;): T &#123;</span><br><span class="line">    <span class="keyword">return</span> factoryProvider.<span class="title function_">useFactory</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 用于获取类构造函数中声明的依赖对象 重点&amp;难点</span></span><br><span class="line">  <span class="keyword">private</span> getInjectedParams&lt;T&gt;(<span class="attr">target</span>: <span class="title class_">Type</span>&lt;T&gt;) &#123;</span><br><span class="line">    <span class="comment">// 获取参数的类型 &quot;design:paramtypes&quot; 用于修饰目标对象方法的参数类型</span></span><br><span class="line">    <span class="keyword">const</span> argTypes = <span class="title class_">Reflect</span>.<span class="title function_">getMetadata</span>(<span class="variable constant_">REFLECT_PARAMS</span>, target) <span class="keyword">as</span> (<span class="title class_">InjectableParam</span> | <span class="literal">undefined</span>)[];</span><br><span class="line">    <span class="keyword">if</span>(argTypes === <span class="literal">undefined</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> [];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> argTypes.<span class="title function_">map</span>(<span class="function">(<span class="params">argTypes, index</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span>(argTypes === <span class="literal">undefined</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span> (</span><br><span class="line">          <span class="string">`Injection error. Recursive dependency detected in constructor for type <span class="subst">$&#123;target.name&#125;</span> with parameter at index <span class="subst">$&#123;index&#125;</span>`</span></span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">const</span> overrideToken = <span class="title function_">getInjectionToken</span>(target, index);</span><br><span class="line">      <span class="keyword">const</span> actualToken = overrideToken === <span class="literal">undefined</span> ? argTypes : overrideToken;</span><br><span class="line">      <span class="keyword">let</span> provider = <span class="variable language_">this</span>.<span class="property">providers</span>.<span class="title function_">get</span>(actualToken);</span><br><span class="line">      <span class="comment">// 递归调用 一层接一层</span></span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">injectWithProvider</span>(actualToken, provider);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 已注入容器的实例添加到变量instances</span></span><br><span class="line">  <span class="keyword">private</span> addInstances&lt;T&gt;(<span class="attr">type</span>: <span class="title class_">Token</span>&lt;T&gt;, <span class="attr">instance</span>: <span class="built_in">any</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">instances</span>.<span class="title function_">set</span>(<span class="keyword">type</span>, instance);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>4、调用demo</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Container</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./container&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Injectable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./Injectable&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Inject</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./Inject&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">InjectionToken</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./provider&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">API_URL</span> = <span class="keyword">new</span> <span class="title class_">InjectionToken</span>(<span class="string">&#x27;apiUrl&#x27;</span>);</span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HttpClient</span>&#123;</span><br><span class="line">  <span class="title function_">get</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;get&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HttpService</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="comment">// 使用这种方式是如何将HttpClient注入的 使用Reflect.getMetadata(&#x27;design:paramtypes&#x27;, target)获取target类的参数类型信息</span></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> httpClient: HttpClient,</span></span><br><span class="line"><span class="params">    <span class="meta">@Inject</span>(API_URL) <span class="keyword">private</span> apiUrl: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  </span>) &#123; &#125;</span><br><span class="line">  <span class="title function_">test</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">apiUrl</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">httpClient</span>.<span class="title function_">get</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> container = <span class="keyword">new</span> <span class="title class_">Container</span>();</span><br><span class="line"><span class="comment">// addProvider 这一步就相当于angular中在module中的providers添加Service</span></span><br><span class="line">container.<span class="title function_">addProvider</span>(&#123;</span><br><span class="line">  <span class="attr">provide</span>: <span class="variable constant_">API_URL</span>,</span><br><span class="line">  <span class="attr">useValue</span>: <span class="string">&#x27;https://www.666.com/&#x27;</span></span><br><span class="line">&#125;);</span><br><span class="line">container.<span class="title function_">addProvider</span>(&#123;<span class="attr">provide</span>: <span class="title class_">HttpService</span>, <span class="attr">useClass</span>: <span class="title class_">HttpService</span> &#125;);</span><br><span class="line">container.<span class="title function_">addProvider</span>(&#123;<span class="attr">provide</span>: <span class="title class_">HttpClient</span>, <span class="attr">useClass</span>: <span class="title class_">HttpClient</span> &#125;);</span><br><span class="line"><span class="keyword">const</span> httpService = container.<span class="title function_">inject</span>(<span class="title class_">HttpService</span>);</span><br><span class="line">httpService.<span class="title function_">test</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// https://www.666.com/</span></span><br><span class="line"><span class="comment">// get</span></span><br></pre></td></tr></table></figure>
<h3 id="关键点">关键点</h3>
<p>1、<code>Reflect.getMetadata('design:paramtypes', value)</code>：获取类构造函数参数的类型</p>
<p>2、<code>Reflect.construct(data, params)</code>：实例化类</p>
<p>3、类中依赖如果存在多层采用递归注入方式</p>
<p>完整代码 <a target="_blank" rel="noopener" href="https://github.com/YonSunZhen/technology/tree/master/design-pattern/Dependency%20Injection/ng-di2">查看</a></p>
<h2 id="疑问">疑问</h2>
<p>1、一种消除类之间依赖关系的设计模式，具体是如何体现的？貌似还是存在依赖，只是封装起来了而已？<br>
解答：将所有的类与类之间的依赖关系交给IoC容器去管理，之后真正使用的是IoC容器中已存在依赖关系的类的实例（并非再去创建新的实例，因此并不会影响类源代码逻辑，个人猜想：若后面需要扩展需求可以根据源类再创建别的容器）；</p>
<p>2、angular中同个Service在多个地方注入，获取依赖时如何确定要获取哪一个值？<br>
解答：如果是在同一个注入容器重复注入，按照注入的先后顺序，后面注入的会重写前面注入的；</p>
<p>3、在<code>construct</code>中<code>private httpClient: HttpClient</code>是如何将<code>HttpClient</code>注入依赖的？<br>
解答：使用<code>Reflect.getMetadata('design:paramtypes', target)</code>获取<code>target</code>类的参数类型信息；</p>

      </div>
        <div class="support-author">
          <p>感谢您的阅读。 🙏
          <a href="https://888.com/index.html" target="_blank">关于转载请看这里</a>
            <!--<a class="btn-pay"  href="#pay-modal">¥ 打赏支持</a>-->
          </p>
        </div>
        <!--
            <div class="like ">
              <div class="like-button">
                <a id="like-note" href="">
                  <i class="icon-heart"></i>喜欢
                </a>
              </div>
              <span id="likes-count">256</span>
            </div>
        -->
        <div class="otherLink">
          <div class="previous">
          </div>
          <div class="next">
          </div>
        </div>
        <div class="comments" id="comments">
          
<script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
<script src="/js/md5.min.js"></script>
<script type="text/javascript">
  const gitalk = new Gitalk({
    clientID: '4008c278909d8497d8ad',
    clientSecret: 'e27df4736052523348bbf856ba03e1d350143b93',
    repo: 'YonSunZhen.github.io',
    owner: 'YonSunZhen',
    admin: ['YonSunZhen'],
    id: md5(location.pathname),      // Ensure uniqueness and length less than 50
    distractionFreeMode: false
  })

  gitalk.render('comments');
</script>

        </div>
      </div>
    </div>
   </div>
</main>
<div class="footer">
  <div class="info">
    <p>
    <a target="_blank" rel="noopener" href="https://hexo.io"> Hexo </a> 强力驱动|
      <a target="_blank" rel="noopener" href="https://github.com/Youthink/hexo-themes-yearn"> Yearn </a>
      主题
    </p>
    <p>
      &copy;
      <a href="http://beian.miit.gov.cn" target="_blank">YonSunZhen的个人博客 粤ICP备18135123号 </a> 
    </p>  
  </div>
</div>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<!-- <script src="/./js/canvas-nest.js"></script> -->

<script type="text/javascript" src="/./js/main.4a9772.js"></script>
<script type="text/javascript" src="/./js/jquery-1.6.2.min.js"></script>
<!-- if CDN fails, use local file -->
<script src="https://unpkg.com/mermaid@8.4.6/dist/mermaid.min.js"></script>
<script> window.mermaid || document.write('<script src="/./js/mermaid.min.js"><\/script>')</script>
<script>mermaid.initialize({ startOnLoad: true });</script>

<!-- 
<script src="/assets/js/mermaid.min.js"></script>
 -->
<script>
  $(document).ready(function () {
    var mermaid_config = {
      startOnLoad: true,
      theme: 'dark',
      flowchart: {
        useMaxWidth: false,
        htmlLabels: true
      }
    }
    mermaid.initialize(mermaid_config);
  });
</script>


</body>
</html>
